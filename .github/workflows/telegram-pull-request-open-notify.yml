name: Telegram Open Pull Request Notify

on:
  workflow_call:
    inputs:
      date_format:
        description: "Date format"
        required: false
        type: string
      calendar_type:
        description: "Calendar type"
        required: false
        type: string
        default: "jalali"
      timezone:
        description: "Timezone for date conversion (e.g., UTC, Asia/Tehran)"
        required: false
        type: string
        default: "UTC"
    secrets:
      bot_token:
        description: "Telegram bot token created via BotFather"
        required: true
      chat_id:
        description: "Target Telegram chat ID (user, group, or channel)"
        required: true

jobs:
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        if: inputs.date_format != '' && inputs.date_format != null
        uses: actions/checkout@v4

      - name: Setup PHP
        if: inputs.date_format != '' && inputs.date_format != null
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl

      - name: Install Dependencies
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          if [ -f "composer.json" ]; then
            composer install --no-dev --no-interaction --prefer-dist
          else
            composer require jobmetric/multi-calendar --prefer-dist --no-interaction
          fi
          
          if [ -f "vendor/bin/date-converter.sh" ]; then
            chmod +x vendor/bin/date-converter.sh
          fi

      - name: Send Telegram notification for opened PR
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
          TIMEZONE: ${{ inputs.timezone }}
        shell: bash
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi

          PULL_REQUEST_TITLE="${{ github.event.pull_request.title }}"
          PULL_REQUEST_BODY="${{ github.event.pull_request.body }}"
          PULL_REQUEST_NUMBER="${{ github.event.pull_request.number }}"
          PULL_REQUEST_URL="${{ github.event.pull_request.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"

          CREATED_DATE="$CREATED_AT"
          SCRIPT_PATH="vendor/bin/date-converter.sh"
          
          if [ -n "$DATE_FORMAT" ] && [ -f "$SCRIPT_PATH" ]; then
            set +e
            
            if [ ! -x "$SCRIPT_PATH" ]; then
              chmod +x "$SCRIPT_PATH"
            fi
            
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
               TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi
            
            TARGET_TIMEZONE="${TIMEZONE:-UTC}"
            if [ "$TARGET_CAL" == "jalali" ] || [ "$TARGET_CAL" == "persian" ]; then
              TARGET_TIMEZONE="${TIMEZONE:-Asia/Tehran}"
            fi
            
            DATE_TO_CONVERT="$CREATED_AT"
            FORMAT_INPUT=""
            
            if [[ "$CREATED_AT" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2} ]]; then
              FORMAT_INPUT="Y-m-d\\TH:i:s"
              if [[ "$CREATED_AT" =~ Z$ ]]; then
                DATE_TO_CONVERT="${CREATED_AT%Z}"
              elif [[ "$CREATED_AT" =~ \+[0-9]{2}:[0-9]{2}$ ]]; then
                DATE_TO_CONVERT="${CREATED_AT%+*}"
              elif [[ "$CREATED_AT" =~ -[0-9]{2}:[0-9]{2}$ ]]; then
                DATE_TO_CONVERT="${CREATED_AT%-*}"
              fi
            fi
            
            if [ -n "$FORMAT_INPUT" ]; then
              CONVERTED=$("$SCRIPT_PATH" "$DATE_TO_CONVERT" --date-format gregorian --format-input "$FORMAT_INPUT" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --timezone "$TARGET_TIMEZONE" 2>&1)
              EXIT_CODE=$?
            else
              CONVERTED=$("$SCRIPT_PATH" "$DATE_TO_CONVERT" --date-format gregorian --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --timezone "$TARGET_TIMEZONE" 2>&1)
              EXIT_CODE=$?
            fi
            
            if [ $EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ ^Error ]]; then
               if [ "$DATE_FORMAT" == "both" ]; then
                 CREATED_DATE="${CREATED_AT} / ${CONVERTED} ${TARGET_TIMEZONE}"
               else
                 CREATED_DATE="${CONVERTED} ${TARGET_TIMEZONE}"
               fi
            fi
            set -e
          elif [ -n "$CREATED_AT" ]; then
            CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
          else
            CREATED_DATE="N/A"
          fi
          
          PULL_REQUEST_TITLE_ESC=$(printf '%s' "$PULL_REQUEST_TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' 2>&1 || echo "$PULL_REQUEST_TITLE")
          
          PULL_REQUEST_BODY_ESC=""
          if [ -n "$PULL_REQUEST_BODY" ] && [ "$PULL_REQUEST_BODY" != "null" ]; then
            PULL_REQUEST_BODY_ESC=$(printf '%s' "$PULL_REQUEST_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' | head -c 1000 2>&1 || echo "")
            if [ ${#PULL_REQUEST_BODY_ESC} -gt 1000 ]; then
              PULL_REQUEST_BODY_ESC="${PULL_REQUEST_BODY_ESC:0:1000}"
            fi
          fi
          
          MESSAGE="Open PR <b><code>${REPO}</code> #${PULL_REQUEST_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<b>${PULL_REQUEST_TITLE_ESC}</b>"$'\n\n'

          if [ -n "$PULL_REQUEST_BODY_ESC" ]; then
            MESSAGE="${MESSAGE}<b>${PULL_REQUEST_BODY_ESC}</b> "$'\n\n'
          fi

          MESSAGE="${MESSAGE}Author: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE:-N/A}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${PULL_REQUEST_URL}\">View Pull Request on GitHub</a>"
          
          MAX_MESSAGE_LENGTH=4096
          if [ ${#MESSAGE} -gt $MAX_MESSAGE_LENGTH ]; then
            MESSAGE="${MESSAGE:0:$MAX_MESSAGE_LENGTH}"
          fi
          
          set +e
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true 2>&1)
          
          CURL_EXIT_CODE=$?
          set -e
          
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            exit 1
          fi

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ -z "$HTTP_CODE" ] || [ "$HTTP_CODE" != "200" ]; then
            exit 1
          fi
