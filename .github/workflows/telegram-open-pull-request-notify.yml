name: Telegram Open Pull Request Notify

on:
  workflow_call:
    secrets:
      bot_token:
        description: "Telegram bot token created via BotFather"
        required: true
      chat_id:
        description: "Target Telegram chat ID (user, group, or channel)"
        required: true

jobs:
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Telegram message
        id: prepare_message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
        shell: bash
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping Pull Request notification."
            exit 0
          fi

          # Get Pull Request details
          PULL_REQUEST_TITLE="${{ github.event.pull_request.title }}"
          PULL_REQUEST_BODY="${{ github.event.pull_request.body }}"
          PULL_REQUEST_NUMBER="${{ github.event.pull_request.number }}"
          PULL_REQUEST_URL="${{ github.event.pull_request.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"

          # Format date (convert ISO 8601 to readable format)
          if [ -n "$CREATED_AT" ]; then
            CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
          else
            CREATED_DATE="N/A"
          fi

          # Escape HTML special characters for Telegram HTML format
          # In Telegram HTML: & < > must be escaped in text content (not in tags)
          # Important: Escape & first, then < and >
          # Use a function to properly escape HTML
          escape_html() {
            printf '%s' "$1" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e "s/\"/\&quot;/g"
          }
          
          PULL_REQUEST_TITLE_ESC=$(escape_html "$PULL_REQUEST_TITLE")
          PULL_REQUEST_BODY_ESC=$(escape_html "$PULL_REQUEST_BODY" | head -c 1000)
          REPO_ESC=$(escape_html "$REPO")
          AUTHOR_ESC=$(escape_html "$AUTHOR")
          CREATED_DATE_ESC=$(escape_html "$CREATED_DATE")

          # Build message with improved HTML formatting
          # Note: Telegram HTML requires proper escaping of special characters in text content
          MESSAGE="Open PR <b><code>${REPO_ESC}</code> #${PULL_REQUEST_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<b>${PULL_REQUEST_TITLE_ESC}</b>"$'\n\n'

          if [ -n "$PULL_REQUEST_BODY_ESC" ] && [ "$PULL_REQUEST_BODY_ESC" != "null" ]; then
            MESSAGE="${MESSAGE}<b>${PULL_REQUEST_BODY_ESC}</b>"$'\n\n'
          fi

          MESSAGE="${MESSAGE}Author: <b><code>${AUTHOR_ESC}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE_ESC}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${PULL_REQUEST_URL}\">View Pull Request on GitHub</a>"

          # Save message to output for next step
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification for opened PR
        uses: jobmetric/github-notify/telegram@master
        with:
          bot_token: ${{ secrets.bot_token }}
          chat_id: ${{ secrets.chat_id }}
          message: ${{ steps.prepare_message.outputs.message }}
          parse_mode: 'HTML'
