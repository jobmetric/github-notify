name: Telegram Issue Reply Notify

on:
  workflow_call:
    inputs:
      date_format:
        description: "Date format: 'jalali' (Persian), 'hijri' (Islamic), 'hebrew', 'buddhist', 'coptic', 'ethiopian', 'chinese', 'both' (Gregorian + selected), or leave empty for default Gregorian"
        required: false
        type: string
      calendar_type:
        description: "Calendar type for conversion: 'jalali', 'hijri', 'hebrew', 'buddhist', 'coptic', 'ethiopian', 'chinese' (used when date_format is 'both')"
        required: false
        type: string
        default: "jalali" 
    secrets:
      bot_token:
        description: "Telegram bot token created via BotFather"
        required: true
      chat_id:
        description: "Target Telegram chat ID (user, group, or channel)"
        required: true

jobs:
  notify-reply-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        if: inputs.date_format != '' && inputs.date_format != null
        uses: actions/checkout@v4

      - name: Setup PHP
        if: inputs.date_format != '' && inputs.date_format != null
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl

      - name: Install Composer dependencies
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          echo "=== Checking Composer ==="
          if ! command -v composer &> /dev/null; then
            echo "‚ö†Ô∏è  Composer is not installed. Installing..."
            curl -sS https://getcomposer.org/installer | php
            sudo mv composer.phar /usr/local/bin/composer
            chmod +x /usr/local/bin/composer
          fi
          
          if command -v composer &> /dev/null; then
            echo "‚úÖ Composer version: $(composer --version)"
          else
            echo "‚ùå Failed to install Composer"
            exit 1
          fi
          
          echo ""
          echo "=== Checking composer.json ==="
          if [ -f "composer.json" ]; then
            echo "‚úÖ composer.json found"
            echo "üìÑ composer.json content:"
            cat composer.json | head -20
          else
            echo "‚ö†Ô∏è  composer.json not found. Skipping dependency installation."
            exit 0
          fi
          
          echo ""
          echo "=== Installing dependencies ==="
          if composer install --no-dev --no-interaction --prefer-dist 2>&1; then
            echo "‚úÖ Dependencies installed successfully"
          else
            echo "‚ùå Failed to install dependencies"
            echo "‚ö†Ô∏è  Continuing without dependencies (date conversion may not work)"
          fi
          
          echo ""
          echo "=== Checking MultiCalendar package ==="
          if [ -d "vendor/jobmetric/multi-calendar" ]; then
            echo "‚úÖ MultiCalendar package found"
            PACKAGE_DIR="vendor/jobmetric/multi-calendar"
            
            # Check for script in common locations
            SCRIPT_FOUND=false
            for script_path in "bin/convert-date.sh" "scripts/convert-date.sh" ".github/scripts/convert-date.sh"; do
              if [ -f "$PACKAGE_DIR/$script_path" ]; then
                echo "‚úÖ Script found at: $PACKAGE_DIR/$script_path"
                SCRIPT_FOUND=true
                break
              fi
            done
            
            if [ "$SCRIPT_FOUND" = false ]; then
              echo "‚ö†Ô∏è  convert-date.sh script not found in package"
              echo "üìÅ Package directory contents:"
              ls -la "$PACKAGE_DIR" | head -10
            fi
          else
            echo "‚ö†Ô∏è  MultiCalendar package not found in vendor/"
            echo "üìÅ Vendor directory contents:"
            ls -la vendor/ 2>/dev/null | head -10 || echo "vendor/ directory does not exist"
          fi

      - name: Send Telegram notification for issue comment
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
        shell: bash
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi

          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          COMMENT_URL="${{ github.event.comment.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          CREATED_AT="${{ github.event.comment.created_at }}"

          # Debug: Check if variables are set
          echo "=== Debug: Variables ==="
          echo "COMMENT_BODY length: ${#COMMENT_BODY}"
          echo "ISSUE_TITLE: $ISSUE_TITLE"
          echo "ISSUE_NUMBER: $ISSUE_NUMBER"
          echo "AUTHOR: $AUTHOR"
          echo "CREATED_AT: $CREATED_AT"
          echo "========================="

          # Format date (convert ISO 8601 to readable format)
          if [ -n "$CREATED_AT" ]; then
            CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
            
            # Convert date if date_format is set
            if [ -n "$DATE_FORMAT" ] && [ "$DATE_FORMAT" != "" ]; then
              echo ""
              echo "=== Converting date ==="
              echo "üìÖ Original date: $CREATED_AT"
              echo "üìÜ Date format: $DATE_FORMAT"
              
              # Determine calendar type
              CALENDAR_TYPE_TO_USE="jalali"
              if [ "$DATE_FORMAT" = "both" ]; then
                CALENDAR_TYPE_TO_USE="${CALENDAR_TYPE:-jalali}"
                echo "üìÖ Calendar type: $CALENDAR_TYPE_TO_USE"
              elif [ "$DATE_FORMAT" != "both" ]; then
                CALENDAR_TYPE_TO_USE="$DATE_FORMAT"
                echo "üìÖ Calendar type: $CALENDAR_TYPE_TO_USE"
              fi
              
              # Check PHP availability
              if ! command -v php &> /dev/null; then
                echo "‚ùå PHP is not installed or not in PATH"
                CREATED_DATE_CONVERTED=""
              else
                echo "‚úÖ PHP version: $(php -v | head -1)"
                
                # Try to find convert-date.sh script in MultiCalendar package
                SCRIPT_PATH=""
                POSSIBLE_PATHS=(
                  "vendor/jobmetric/multi-calendar/bin/convert-date.sh"
                  "vendor/jobmetric/multi-calendar/scripts/convert-date.sh"
                  "vendor/jobmetric/multi-calendar/.github/scripts/convert-date.sh"
                )
                
                echo "üîç Searching for convert-date.sh script..."
                for path in "${POSSIBLE_PATHS[@]}"; do
                  if [ -f "$path" ]; then
                    SCRIPT_PATH="$path"
                    echo "‚úÖ Script found at: $path"
                    break
                  else
                    echo "  ‚ö†Ô∏è  Not found: $path"
                  fi
                done
                
                if [ -n "$SCRIPT_PATH" ]; then
                  chmod +x "$SCRIPT_PATH" 2>/dev/null || true
                  echo "üîÑ Converting date to $CALENDAR_TYPE_TO_USE..."
                  CREATED_DATE_CONVERTED=$("$SCRIPT_PATH" "$CREATED_AT" "$CALENDAR_TYPE_TO_USE" "Y-m-d H:i:s" 2>&1)
                  
                  if [ -n "$CREATED_DATE_CONVERTED" ] && [ "$CREATED_DATE_CONVERTED" != "" ] && [[ ! "$CREATED_DATE_CONVERTED" =~ ^Error ]]; then
                    echo "‚úÖ Converted date: $CREATED_DATE_CONVERTED"
                  else
                    echo "‚ùå Date conversion failed: $CREATED_DATE_CONVERTED"
                    CREATED_DATE_CONVERTED=""
                  fi
                else
                  echo "‚ùå convert-date.sh script not found in MultiCalendar package"
                  echo "‚ö†Ô∏è  Date conversion will be skipped"
                  CREATED_DATE_CONVERTED=""
                fi
              fi
              
              if [ -n "$CREATED_DATE_CONVERTED" ] && [ "$CREATED_DATE_CONVERTED" != "" ]; then
                if [ "$DATE_FORMAT" = "both" ]; then
                  CREATED_DATE="${CREATED_DATE} / ${CREATED_DATE_CONVERTED}"
                else
                  CREATED_DATE="$CREATED_DATE_CONVERTED"
                fi
                echo "‚úÖ Final date format: $CREATED_DATE"
              else
                if [ "$DATE_FORMAT" = "both" ]; then
                  echo "‚ö†Ô∏è  Using Gregorian date only (conversion failed)"
                else
                  echo "‚ùå Date conversion failed, using Gregorian date"
                  CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
                fi
              fi
            fi
          else
            CREATED_DATE="N/A"
          fi

          # Escape HTML special characters
          ISSUE_TITLE_ESC=$(echo "$ISSUE_TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          COMMENT_BODY_ESC=$(echo "$COMMENT_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' | head -c 1000)

          MESSAGE="New comment on issue <b><code>${REPO}</code> #${ISSUE_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}Title issue: <b>${ISSUE_TITLE_ESC}</b>"$'\n\n'

          if [ -n "$COMMENT_BODY_ESC" ] && [ "$COMMENT_BODY_ESC" != "null" ] && [ "$COMMENT_BODY_ESC" != "" ]; then
            MESSAGE="${MESSAGE}Comment issue: ${COMMENT_BODY_ESC}"$'\n\n'
          fi

          MESSAGE="${MESSAGE}Commented by: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${ISSUE_URL}\">View Issue on GitHub</a>"$'\n'
          MESSAGE="${MESSAGE}<a href=\"${COMMENT_URL}\">View Comment on GitHub</a>"

          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Telegram reply issue notification sent successfully"
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
