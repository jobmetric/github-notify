name: Telegram Issue Reply Notify

on:
  workflow_call:
    inputs:
      date_format:
        description: "Date format"
        required: false
        type: string
      calendar_type:
        description: "Calendar type"
        required: false
        type: string
        default: "jalali"
    secrets:
      bot_token:
        description: "Telegram bot token"
        required: true
      chat_id:
        description: "Target Telegram chat ID"
        required: true

jobs:
  notify-reply-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        if: inputs.date_format != '' && inputs.date_format != null
        uses: actions/checkout@v4

      - name: Setup PHP
        if: inputs.date_format != '' && inputs.date_format != null
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl

      - name: Install Composer and MultiCalendar package
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          echo "=== Checking Composer ==="
          if command -v composer &> /dev/null; then
            echo "‚úÖ Composer is installed."
            echo "Composer version: $(composer -V | head -1)"
          else
            echo "‚ùå Composer is not installed. Attempting to install..."
            curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
            if command -v composer &> /dev/null; then
              echo "‚úÖ Composer installed successfully."
            else
              echo "‚ùå Failed to install Composer. Date conversion may fail."
              exit 1
            fi
          fi

          echo ""
          echo "=== Installing MultiCalendar package (latest version) ==="
          composer require jobmetric/multi-calendar --prefer-dist --no-interaction
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ MultiCalendar package installed successfully"
            if [ -f "vendor/autoload.php" ]; then
              echo "‚úÖ Autoload file found: vendor/autoload.php"
            else
              echo "‚ö†Ô∏è  Autoload file not found"
            fi
            if [ -d "vendor/jobmetric/multi-calendar" ]; then
              echo "‚úÖ Package directory exists: vendor/jobmetric/multi-calendar"
            fi
          else
            echo "‚ùå Failed to install MultiCalendar package"
            exit 1
          fi

      - name: Setup Date Converter Script
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          echo "=== Setting up convert-date.sh script ==="
          
          SCRIPT_PATH=""
          POSSIBLE_PATHS=(
            "vendor/jobmetric/multi-calendar/bin/convert-date.sh"
            "vendor/jobmetric/multi-calendar/convert-date.sh"
            "vendor/jobmetric/multi-calendar/.github/scripts/convert-date.sh"
          )
          
          echo "üîç Searching for script in package..."
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path" ]; then
              SCRIPT_PATH="$path"
              echo "‚úÖ Script found: $path"
              break
            fi
          done
          
          if [ -z "$SCRIPT_PATH" ]; then
            echo "‚ö†Ô∏è  Script not found in package"
            echo "üì• Downloading from repository..."
            curl -sSL https://raw.githubusercontent.com/jobmetric/multi-calendar/master/bin/convert-date.sh -o convert-date.sh || \
            curl -sSL https://raw.githubusercontent.com/jobmetric/multi-calendar/main/bin/convert-date.sh -o convert-date.sh || {
              echo "‚ùå Failed to download script"
              exit 1
            }
            SCRIPT_PATH="convert-date.sh"
            echo "‚úÖ Script downloaded: $SCRIPT_PATH"
          fi
          
          chmod +x "$SCRIPT_PATH"
          echo "‚úÖ Script is executable"
          
          if [ "$SCRIPT_PATH" != "convert-date.sh" ]; then
            cp "$SCRIPT_PATH" convert-date.sh
            echo "‚úÖ Script copied to: convert-date.sh"
          fi
          
          echo "‚úÖ Date converter script ready"

      - name: Send Telegram notification for issue comment
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
        shell: bash
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi

          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          COMMENT_URL="${{ github.event.comment.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          CREATED_AT="${{ github.event.comment.created_at }}"
          
          CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d" 2>/dev/null || echo "$CREATED_AT")
          
          if [ -n "$DATE_FORMAT" ] && [ -f "./convert-date.sh" ] && [ -f "vendor/autoload.php" ]; then
            echo "=== Converting date ==="
            echo "üìÖ Original date: $CREATED_AT"
            
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
               TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi
            
            echo "üîÑ Target calendar: $TARGET_CAL"
            echo "üîß Converting date..."
            
            chmod +x ./convert-date.sh 2>/dev/null || true
            CONVERTED=$(./convert-date.sh "$CREATED_AT" --to "$TARGET_CAL" --output-format "Y-m-d" 2>&1)
            CONVERT_EXIT_CODE=$?
            
            if [ $CONVERT_EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ ^Error ]]; then
              echo "‚úÖ Date converted: $CONVERTED"
              if [ "$DATE_FORMAT" == "both" ]; then
                CREATED_DATE="${CREATED_DATE} / ${CONVERTED} (${TARGET_CAL})"
              else
                CREATED_DATE="${CONVERTED} (${TARGET_CAL})"
              fi
            else
              echo "‚ö†Ô∏è  Date conversion failed, using Gregorian date"
            fi
          fi
          
          echo "üìÖ Final date: $CREATED_DATE"

          escape_html() { echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'; }
          ISSUE_TITLE_ESC=$(escape_html "$ISSUE_TITLE")
          COMMENT_BODY_ESC=$(escape_html "$COMMENT_BODY" | head -c 1000)

          MESSAGE="New comment on issue <b><code>${REPO}</code> #${ISSUE_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}Title issue: <b>${ISSUE_TITLE_ESC}</b>"$'\n\n'
          
          if [ -n "$COMMENT_BODY_ESC" ] && [ "$COMMENT_BODY_ESC" != "null" ] && [ "$COMMENT_BODY_ESC" != "" ]; then
            MESSAGE="${MESSAGE}Comment issue: ${COMMENT_BODY_ESC}"$'\n\n'
          fi

          MESSAGE="${MESSAGE}Commented by: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${ISSUE_URL}\">View Issue on GitHub</a>"$'\n'
          MESSAGE="${MESSAGE}<a href=\"${COMMENT_URL}\">View Comment on GitHub</a>"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true