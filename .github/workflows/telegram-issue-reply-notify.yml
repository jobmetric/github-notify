name: Telegram Issue Reply Notify

on:
  workflow_call:
    inputs:
      date_format:
        description: "Date format"
        required: false
        type: string
      calendar_type:
        description: "Calendar type"
        required: false
        type: string
        default: "jalali"
      timezone:
        description: "Timezone for date conversion"
        required: false
        type: string
        default: "UTC"
    secrets:
      bot_token:
        description: "Telegram bot token"
        required: true
      chat_id:
        description: "Target Telegram chat ID"
        required: true

jobs:
  notify-reply-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        if: inputs.date_format != '' && inputs.date_format != null
        uses: actions/checkout@v4

      - name: Setup PHP
        if: inputs.date_format != '' && inputs.date_format != null
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl

      - name: Install Dependencies
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          if [ -f "composer.json" ]; then
            composer install --no-dev --no-interaction --prefer-dist
          else
            composer require jobmetric/multi-calendar:dev-main --prefer-dist --no-interaction || composer require jobmetric/multi-calendar:dev-master --prefer-dist --no-interaction
          fi
          
          chmod +x vendor/bin/date-converter* || true

      - name: Send Telegram notification for issue comment
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
          TIMEZONE: ${{ inputs.timezone }}
        shell: bash
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi

          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          COMMENT_URL="${{ github.event.comment.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          CREATED_AT="${{ github.event.comment.created_at }}"
          
          CREATED_DATE="$CREATED_AT"
          
          echo "DEBUG: DATE_FORMAT input = '$DATE_FORMAT'"
          echo "DEBUG: CALENDAR_TYPE input = '$CALENDAR_TYPE'"
          echo "DEBUG: TIMEZONE input = '$TIMEZONE'"
          echo "DEBUG: DATE_FORMAT is empty check: [ -n \"$DATE_FORMAT\" ] = $([ -n "$DATE_FORMAT" ] && echo "true" || echo "false")"
          
          if [ -n "$DATE_FORMAT" ] && [ "$DATE_FORMAT" != "null" ] && [ "$DATE_FORMAT" != "" ]; then
            echo "DEBUG: Entering date conversion block"
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
               TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi
            
            if [ "$TARGET_CAL" == "jalali" ] || [ "$TARGET_CAL" == "persian" ]; then
              TARGET_TIMEZONE="${TIMEZONE:-Asia/Tehran}"
            else
              TARGET_TIMEZONE="${TIMEZONE:-UTC}"
            fi
            
            CONVERTER_BIN=""
            echo "DEBUG: Looking for date-converter binary..."
            if [ -f "vendor/bin/date-converter" ]; then
                CONVERTER_BIN="vendor/bin/date-converter"
                echo "DEBUG: Found vendor/bin/date-converter"
            elif [ -f "vendor/bin/date-converter.sh" ]; then
                CONVERTER_BIN="vendor/bin/date-converter.sh"
                echo "DEBUG: Found vendor/bin/date-converter.sh"
            else
                echo "DEBUG: date-converter binary NOT FOUND!"
                echo "DEBUG: Checking vendor/bin directory..."
                ls -la vendor/bin/ 2>&1 || echo "DEBUG: vendor/bin directory does not exist"
            fi
            echo "DEBUG: CONVERTER_BIN = '$CONVERTER_BIN'"

            if [ -n "$CONVERTER_BIN" ]; then
              echo "DEBUG: Converter binary found, proceeding with conversion"
              set +e
              echo "DEBUG: CREATED_AT = $CREATED_AT"
              DATE_TO_CONVERT="${CREATED_AT}"
              DATE_TO_CONVERT="${DATE_TO_CONVERT%Z}"
              if [[ "$DATE_TO_CONVERT" == *"+"* ]]; then
                DATE_TO_CONVERT="${DATE_TO_CONVERT%%+*}"
              fi
              if [[ "$DATE_TO_CONVERT" == *"-"* ]] && [[ "$DATE_TO_CONVERT" =~ [0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}- ]]; then
                DATE_TO_CONVERT="${DATE_TO_CONVERT%%-*}"
              fi
              echo "DEBUG: DATE_TO_CONVERT = $DATE_TO_CONVERT"
              echo "DEBUG: TARGET_CAL = $TARGET_CAL"
              echo "DEBUG: TARGET_TIMEZONE = $TARGET_TIMEZONE"
              echo "DEBUG: Command: php $CONVERTER_BIN \"$DATE_TO_CONVERT\" --date-format gregorian --format-input \"Y-m-d\\TH:i:s\" --to \"$TARGET_CAL\" --format-output \"Y-m-d H:i:s\" --from-timezone UTC --to-timezone \"$TARGET_TIMEZONE\""
              CONVERTED=$(php "$CONVERTER_BIN" "$DATE_TO_CONVERT" --date-format gregorian --format-input "Y-m-d\TH:i:s" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --from-timezone UTC --to-timezone "$TARGET_TIMEZONE" 2>&1)
              EXIT_CODE=$?
              echo "DEBUG: EXIT_CODE = $EXIT_CODE"
              echo "DEBUG: CONVERTED = $CONVERTED"
              set -e
              
              if [ $EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ ^Error ]] && [[ ! "$CONVERTED" =~ ^Warning ]]; then
                CLEAN_DATE=$(echo "$CONVERTED" | tail -n1)
                echo "DEBUG: CLEAN_DATE = $CLEAN_DATE"
                if [ "$DATE_FORMAT" == "both" ]; then
                  CREATED_DATE="${CREATED_AT} / ${CLEAN_DATE} (${TARGET_TIMEZONE})"
                else
                  CREATED_DATE="${CLEAN_DATE} (${TARGET_TIMEZONE})"
                fi
                echo "DEBUG: CREATED_DATE (final) = $CREATED_DATE"
              else
                echo "DEBUG: Conversion failed or returned error/warning. Using original CREATED_AT"
                echo "DEBUG: CREATED_DATE (fallback) = $CREATED_DATE"
              fi
            fi
          fi

          ISSUE_TITLE_ESC=$(echo "$ISSUE_TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          
          COMMENT_BODY_ESC=""
          if [ -n "$COMMENT_BODY" ] && [ "$COMMENT_BODY" != "null" ]; then
            COMMENT_BODY_ESC=$(echo "$COMMENT_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' | head -c 1000)
            if [ ${#COMMENT_BODY_ESC} -gt 1000 ]; then
              COMMENT_BODY_ESC="${COMMENT_BODY_ESC:0:1000}..."
            fi
          fi
          
          echo "DEBUG: Final CREATED_DATE before message = $CREATED_DATE"
          MESSAGE="New comment on issue <b><code>${REPO}</code> #${ISSUE_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}Title: <b>${ISSUE_TITLE_ESC}</b>"$'\n\n'
          
          if [ -n "$COMMENT_BODY_ESC" ] && [ "$COMMENT_BODY_ESC" != "null" ]; then
            MESSAGE="${MESSAGE}Comment: ${COMMENT_BODY_ESC}"$'\n\n'
          fi

          MESSAGE="${MESSAGE}By: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE}</b>"$'\n\n'
          echo "DEBUG: Final MESSAGE Time part = Time: <b>${CREATED_DATE}</b>"
          MESSAGE="${MESSAGE}<a href=\"${ISSUE_URL}\">View Issue</a> | <a href=\"${COMMENT_URL}\">View Comment</a>"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            exit 1
          fi