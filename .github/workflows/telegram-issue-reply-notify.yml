name: Telegram Issue Reply Notify

on:
  workflow_call:
    inputs:
      date_format:
        description: "Date format"
        required: false
        type: string
      calendar_type:
        description: "Calendar type"
        required: false
        type: string
        default: "jalali"
    secrets:
      bot_token:
        description: "Telegram bot token"
        required: true
      chat_id:
        description: "Target Telegram chat ID"
        required: true

jobs:
  notify-reply-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        if: inputs.date_format != '' && inputs.date_format != null
        uses: actions/checkout@v4

      - name: Setup PHP
        if: inputs.date_format != '' && inputs.date_format != null
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl

      - name: Install Composer and MultiCalendar package
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          echo "=== Checking Composer ==="
          if command -v composer &> /dev/null; then
            echo "‚úÖ Composer is installed."
            echo "Composer version: $(composer -V | head -1)"
          else
            echo "‚ùå Composer is not installed. Attempting to install..."
            curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
            if command -v composer &> /dev/null; then
              echo "‚úÖ Composer installed successfully."
            else
              echo "‚ùå Failed to install Composer. Date conversion may fail."
              exit 1
            fi
          fi

          echo ""
          echo "=== Installing MultiCalendar package ==="
          composer require jobmetric/multi-calendar --prefer-dist --no-interaction
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ MultiCalendar package installed successfully."
            if [ -f "vendor/autoload.php" ]; then
              echo "‚úÖ Autoload file found at: vendor/autoload.php"
            else
              echo "‚ö†Ô∏è  Autoload file not found. Date conversion may fail."
            fi
          else
            echo "‚ùå Failed to install MultiCalendar package. Date conversion may fail."
          fi

      - name: Create Date Converter Script
        if: inputs.date_format != '' && inputs.date_format != null
        run: |
          cat << 'EOF' > convert-date.sh
          #!/bin/bash
          DATE=""
          FROM_CAL="gregorian"
          TO_CAL="gregorian"
          FMT_INPUT=""
          FMT_OUTPUT="Y-m-d"

          POSITIONAL=()
          while [[ $# -gt 0 ]]; do
            case "$1" in
              -f|--from) FROM_CAL="${2:-}"; shift 2 ;;
              --from=*) FROM_CAL="${1#*=}"; shift ;;
              -t|--to) TO_CAL="${2:-}"; shift 2 ;;
              --to=*) TO_CAL="${1#*=}"; shift ;;
              -i|--input-format) FMT_INPUT="${2:-}"; shift 2 ;;
              --input-format=*) FMT_INPUT="${1#*=}"; shift ;;
              -o|--output-format) FMT_OUTPUT="${2:-}"; shift 2 ;;
              --output-format=*) FMT_OUTPUT="${1#*=}"; shift ;;
              *) POSITIONAL+=("$1"); shift ;;
            esac
          done
          set -- "${POSITIONAL[@]}"
          DATE="${1:-}"

          AUTOLOAD_FILE=""
          if [ -f "vendor/autoload.php" ]; then
            AUTOLOAD_FILE="vendor/autoload.php"
          fi
          
          if [ -z "$AUTOLOAD_FILE" ]; then
             FIND_AUTOLOAD=$(find . -name "autoload.php" | grep "vendor/autoload.php" | head -n 1)
             if [ -n "$FIND_AUTOLOAD" ]; then
               AUTOLOAD_FILE="$FIND_AUTOLOAD"
             fi
          fi

          if [ -z "$AUTOLOAD_FILE" ]; then
            exit 1
          fi

          AUTOLOAD_FILE="$AUTOLOAD_FILE" \
          MC_DATE="$DATE" \
          MC_FROM="$FROM_CAL" \
          MC_TO="$TO_CAL" \
          MC_FMT_IN="$FMT_INPUT" \
          MC_FMT_OUT="$FMT_OUTPUT" \
          php -r '
          require_once getenv("AUTOLOAD_FILE");
          use JobMetric\MultiCalendar\Console\ConvertDateCommand;
          function env(string $k): ?string {
              $v = getenv($k);
              return ($v === false || $v === "") ? null : $v;
          }
          try {
              $cmd = new ConvertDateCommand();
              echo $cmd->execute(env("MC_TO"), env("MC_FMT_OUT"), env("MC_DATE"), env("MC_FROM") ?? "gregorian", env("MC_FMT_IN")) . PHP_EOL;
          } catch (Throwable $e) {
              fwrite(STDERR, $e->getMessage());
              exit(1);
          }
          '
          EOF
          chmod +x convert-date.sh

      - name: Send Telegram notification for issue comment
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
        shell: bash
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi

          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          COMMENT_URL="${{ github.event.comment.html_url }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          CREATED_AT="${{ github.event.comment.created_at }}"
          
          CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
          
          if [ -n "$DATE_FORMAT" ] && [ -f "./convert-date.sh" ]; then
            echo ""
            echo "=== Converting date ==="
            echo "üìÖ Original date: $CREATED_AT"
            
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
               TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi
            
            echo "üîÑ Target calendar: $TARGET_CAL"
            echo "üîç Checking convert-date.sh script..."
            if [ -f "./convert-date.sh" ]; then
              echo "‚úÖ Script found."
              chmod +x ./convert-date.sh 2>/dev/null || true
              
              echo "üîÑ Converting date..."
              CONVERTED=$(./convert-date.sh "$CREATED_AT" --to "$TARGET_CAL" --output-format "Y-m-d H:i:s" 2>&1)
              CONVERT_EXIT_CODE=$?
              
              if [ $CONVERT_EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ ^Error ]]; then
                echo "‚úÖ Converted date: $CONVERTED"
                if [ "$DATE_FORMAT" == "both" ]; then
                  CREATED_DATE="${CREATED_DATE} / ${CONVERTED} (${TARGET_CAL})"
                else
                  CREATED_DATE="${CONVERTED} (${TARGET_CAL})"
                fi
              else
                echo "‚ùå Date conversion failed: $CONVERTED"
                echo "‚ö†Ô∏è  Using Gregorian date only (conversion failed)"
              fi
            else
              echo "‚ùå convert-date.sh script not found"
              echo "‚ö†Ô∏è  Date conversion will be skipped. Using Gregorian date only."
            fi
          fi

          escape_html() { echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'; }
          ISSUE_TITLE_ESC=$(escape_html "$ISSUE_TITLE")
          COMMENT_BODY_ESC=$(escape_html "$COMMENT_BODY" | head -c 1000)

          MESSAGE="New comment on issue <b><code>${REPO}</code> #${ISSUE_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}Title issue: <b>${ISSUE_TITLE_ESC}</b>"$'\n\n'
          
          if [ -n "$COMMENT_BODY_ESC" ] && [ "$COMMENT_BODY_ESC" != "null" ] && [ "$COMMENT_BODY_ESC" != "" ]; then
            MESSAGE="${MESSAGE}Comment issue: ${COMMENT_BODY_ESC}"$'\n\n'
          fi

          MESSAGE="${MESSAGE}Commented by: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${ISSUE_URL}\">View Issue on GitHub</a>"$'\n'
          MESSAGE="${MESSAGE}<a href=\"${COMMENT_URL}\">View Comment on GitHub</a>"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true