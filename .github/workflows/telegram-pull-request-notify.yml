name: Telegram Pull Request Notification

on:
  workflow_call:
    secrets:
      bot_token:
        description: "Telegram bot token created via BotFather"
        required: true
      chat_id:
        description: "Target Telegram chat ID (user, group, or channel)"
        required: true
      channel_link:
        description: "Optional Telegram channel link to include in the message"
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.channel_link }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping PR notification."
            exit 0
          fi

          # Get PR details
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"
          IS_DRAFT="${{ github.event.pull_request.draft }}"
          STATE="${{ github.event.pull_request.state }}"
          COMMITS="${{ github.event.pull_request.commits }}"
          CHANGED_FILES="${{ github.event.pull_request.changed_files }}"
          ADDITIONS="${{ github.event.pull_request.additions }}"
          DELETIONS="${{ github.event.pull_request.deletions }}"

          # Format date (convert ISO 8601 to readable format)
          if [ -n "$CREATED_AT" ]; then
            CREATED_DATE=$(date -d "$CREATED_AT" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CREATED_AT")
          else
            CREATED_DATE="N/A"
          fi

          # Determine PR status
          if [ "$IS_DRAFT" = "true" ]; then
            PR_STATUS="‚è≥ <b>Draft</b>"
          else
            PR_STATUS="‚úÖ <b>Ready for Review</b>"
          fi

          # Escape HTML special characters
          PR_TITLE_ESC=$(echo "$PR_TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          PR_BODY_ESC=$(echo "$PR_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' | head -c 1000)

          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO=$'\n'"üì¢ <b>Channel:</b> $TELEGRAM_CHANNEL_LINK"
          fi

          # Build statistics section
          STATS=""
          if [ -n "$COMMITS" ] && [ "$COMMITS" != "null" ]; then
            STATS="${STATS}üìä <b>Commits:</b> ${COMMITS}"
          fi
          if [ -n "$CHANGED_FILES" ] && [ "$CHANGED_FILES" != "null" ]; then
            STATS="${STATS}${STATS:+ | }üìÅ <b>Files:</b> ${CHANGED_FILES}"
          fi
          if [ -n "$ADDITIONS" ] && [ "$ADDITIONS" != "null" ] && [ -n "$DELETIONS" ] && [ "$DELETIONS" != "null" ]; then
            STATS="${STATS}${STATS:+ | }‚ûï${ADDITIONS} ‚ûñ${DELETIONS}"
          fi

          # Build message with improved HTML formatting
          MESSAGE="${MESSAGE}<b>Pull Request #${PR_NUMBER}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<b>${PR_TITLE_ESC}</b>"$'\n\n'
          if [ -n "$PR_BODY_ESC" ] && [ "$PR_BODY_ESC" != "null" ]; then
            MESSAGE="${MESSAGE}"$"<b>${PR_BODY_ESC}</b> "$'\n\n'
          fi
          MESSAGE="${MESSAGE}Repo: <b><code>${REPO}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Author: <b><code>${AUTHOR}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${PR_URL}\">View Pull Request on GitHub</a>"

          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Telegram PR notification sent successfully"
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
